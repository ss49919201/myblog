#!/usr/bin/env node

/**
 * Cloudflare KV Local ç’°å¢ƒç”¨ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ä½œæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 *
 * ä½¿ç”¨æ–¹æ³•:
 * 1. wrangler dev ã‚’èµ·å‹•ã—ã¦ãŠã
 * 2. node scripts/seed-kv-data.js ã‚’å®Ÿè¡Œ
 */

const fs = require("fs");
const path = require("path");

// ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
const dummyPosts = [
  {
    id: "post-001",
    title: "Next.js 15 ã®æ–°æ©Ÿèƒ½ã«ã¤ã„ã¦",
    body: `Next.js 15 ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã€å¤šãã®æ–°æ©Ÿèƒ½ã¨æ”¹å–„ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚

## ä¸»ãªæ–°æ©Ÿèƒ½

### App Router ã®å®‰å®šåŒ–
App Router ãŒ stable ã«ãªã‚Šã€ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã§ã®åˆ©ç”¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

### Server Components ã®æ”¹å–„
React Server Components ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒå¤§å¹…ã«å‘ä¸Šã—ã¾ã—ãŸã€‚

### ç”»åƒæœ€é©åŒ–ã®å¼·åŒ–
Image ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒæ›´ã«æœ€é©åŒ–ã•ã‚Œã€ã‚ˆã‚Šé«˜é€Ÿãªç”»åƒèª­ã¿è¾¼ã¿ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚

ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã«ã‚ˆã‚Šã€ã‚ˆã‚Šé«˜é€Ÿã§åŠ¹ç‡çš„ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹ç™ºãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚`,
  },
  {
    id: "post-002",
    title: "Cloudflare Workers ã¨ KV ã®æ´»ç”¨æ³•",
    body: `Cloudflare Workers ã¨ KV ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€é«˜é€Ÿãªã‚¨ãƒƒã‚¸ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒå®Ÿç¾ã§ãã¾ã™ã€‚

## KV ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ç‰¹å¾´

### ã‚°ãƒ­ãƒ¼ãƒãƒ«åˆ†æ•£
ä¸–ç•Œä¸­ã®ã‚¨ãƒƒã‚¸ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒ‡ãƒ¼ã‚¿ãŒè¤‡è£½ã•ã‚Œã€ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚

### é«˜å¯ç”¨æ€§
99.9% ã®ç¨¼åƒç‡ã‚’ä¿è¨¼ã—ã€ä¿¡é ¼æ€§ã®é«˜ã„ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æä¾›ã—ã¾ã™ã€‚

### ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£
è‡ªå‹•çš„ã«ã‚¹ã‚±ãƒ¼ãƒ«ã—ã€å¤§é‡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚‚å¯¾å¿œã§ãã¾ã™ã€‚

å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã®æ´»ç”¨äº‹ä¾‹ã‚‚ç´¹ä»‹ã—ã¦ã„ãã¾ã™ã€‚`,
  },
  {
    id: "post-003",
    title: "React Server Components ã®å®Ÿè·µçš„ãªä½¿ã„æ–¹",
    body: `React Server Components (RSC) ã‚’å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§æ´»ç”¨ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

## Server Components ã®ãƒ¡ãƒªãƒƒãƒˆ

### ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã®å‰Šæ¸›
ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ãŸã‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ä¿¡ã•ã‚Œã‚‹JavaScriptãŒå‰Šæ¸›ã•ã‚Œã¾ã™ã€‚

### SEO ã®å‘ä¸Š
ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§HTMLãŒç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ã€SEOã«æœ‰åˆ©ã§ã™ã€‚

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å‘ä¸Š
åˆæœŸè¡¨ç¤ºãŒé«˜é€ŸåŒ–ã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ãŒå‘ä¸Šã—ã¾ã™ã€‚

## å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ

- "use client" ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã®é©åˆ‡ãªä½¿ç”¨
- ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒãƒ³ã‚°ã®æœ€é©åŒ–
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®æ¤œè¨

ã“ã‚Œã‚‰ã®ãƒã‚¤ãƒ³ãƒˆã‚’æŠ¼ã•ãˆã‚‹ã“ã¨ã§ã€åŠ¹ç‡çš„ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒé–‹ç™ºã§ãã¾ã™ã€‚`,
  },
  {
    id: "post-004",
    title: "TypeScript 5.x ã®æ–°æ©Ÿèƒ½ã¨æ´»ç”¨æ³•",
    body: `TypeScript 5.x ã‚·ãƒªãƒ¼ã‚ºã§è¿½åŠ ã•ã‚ŒãŸæ–°æ©Ÿèƒ½ã«ã¤ã„ã¦ã€å®Ÿè·µçš„ãªè¦³ç‚¹ã‹ã‚‰è§£èª¬ã—ã¾ã™ã€‚

## ä¸»ãªæ–°æ©Ÿèƒ½

### const assertions ã®å¼·åŒ–
ã‚ˆã‚Šæ­£ç¢ºãªå‹æ¨è«–ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚

### template literal types ã®æ”¹å–„
æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«å‹ã®æ“ä½œãŒã‚ˆã‚ŠæŸ”è»Ÿã«ãªã£ã¦ã„ã¾ã™ã€‚

### satisfies operator
å‹ã®å®‰å…¨æ€§ã‚’ä¿ã¡ãªãŒã‚‰ã€ã‚ˆã‚Šè¡¨ç¾åŠ›è±Šã‹ãªã‚³ãƒ¼ãƒ‰ãŒæ›¸ã‘ã¾ã™ã€‚

## å®Ÿè·µã§ã®æ´»ç”¨

ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã‚’å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§æ´»ç”¨ã™ã‚‹å…·ä½“çš„ãªä¾‹ã‚‚ç´¹ä»‹ã—ã¦ã„ãã¾ã™ã€‚`,
  },
  {
    id: "post-005",
    title: "Web Performance æœ€é©åŒ–ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹",
    body: `Webã‚µã‚¤ãƒˆã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã«ã¤ã„ã¦ã€å®Ÿè·µçš„ãªãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## Core Web Vitals ã®æ”¹å–„

### LCP (Largest Contentful Paint)
- ç”»åƒã®æœ€é©åŒ–
- ãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿æœ€é©åŒ–
- Critical CSS ã®å®Ÿè£…

### FID (First Input Delay)
- JavaScript ã®æœ€é©åŒ–
- Code Splitting ã®æ´»ç”¨
- Lazy Loading ã®å®Ÿè£…

### CLS (Cumulative Layout Shift)
- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚·ãƒ•ãƒˆã®é˜²æ­¢
- ç”»åƒã‚µã‚¤ã‚ºã®äº‹å‰æŒ‡å®š
- Web ãƒ•ã‚©ãƒ³ãƒˆã®æœ€é©åŒ–

ã“ã‚Œã‚‰ã®æŒ‡æ¨™ã‚’æ”¹å–„ã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã¨SEOã®ä¸¡æ–¹ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚`,
  },
];

/**
 * KV ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
 */
async function seedKVData() {
  console.log("ğŸŒ± Cloudflare KV Local ã«ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆä¸­...");

  try {
    for (const post of dummyPosts) {
      console.log(`ğŸ“ æŠ•ç¨¿ã‚’ä½œæˆä¸­: ${post.title}`);

      // KV ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã€wrangler kv key put ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨
      const { execSync } = require("child_process");

      // JSONå½¢å¼ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
      const command = `wrangler kv key put "${post.id}" '${JSON.stringify(post)}' --binding KV_POST --local`;

      try {
        execSync(command, { stdio: "inherit" });
        console.log(`âœ… ${post.id} ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
      } catch (error) {
        console.error(`âŒ ${post.id} ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:`, error.message);
      }
    }

    console.log("\nğŸ‰ ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼");
    console.log("\nğŸ“‹ ä½œæˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿:");
    dummyPosts.forEach((post) => {
      console.log(`- ${post.id}: ${post.title}`);
    });
  } catch (error) {
    console.error("âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
    process.exit(1);
  }
}

/**
 * KV ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã™ã‚‹é–¢æ•°
 */
async function listKVData() {
  console.log("\nğŸ” KV ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªä¸­...");

  try {
    const { execSync } = require("child_process");
    const command = "wrangler kv key list --binding KV_POST --local";

    const result = execSync(command, { encoding: "utf8" });
    console.log("ğŸ“‹ ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼:", result);
  } catch (error) {
    console.error("âŒ ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ:", error.message);
  }
}

/**
 * ãƒ¡ã‚¤ãƒ³å‡¦ç†
 */
async function main() {
  const args = process.argv.slice(2);

  if (args.includes("--list")) {
    await listKVData();
  } else if (args.includes("--help")) {
    console.log(`
Cloudflare KV Local ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

ä½¿ç”¨æ–¹æ³•:
  node scripts/seed-kv-data.js           ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
  node scripts/seed-kv-data.js --list    ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
  node scripts/seed-kv-data.js --help    ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º

å‰ææ¡ä»¶:
- wrangler ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨
- wrangler dev ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ (åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§)
    `);
  } else {
    await seedKVData();
    await listKVData();
  }
}

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
if (require.main === module) {
  main().catch(console.error);
}

module.exports = { dummyPosts, seedKVData, listKVData };
